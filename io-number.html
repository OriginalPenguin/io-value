<!--
I/O element for number data type.

    <io-number value="3.141592653589793"></io-number>

@element io-number
@extends io-base-editable
@homepage https://github.com/arodic/io-value
@demo http://akirodic.com/components/io-value/demo.html
@blurb I/O element for number data type.
@status alpha
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="_io-base-behavior.html">
<link rel="import" href="_io-editable-behavior.html">

<dom-module id="io-number">
  <link rel="import" type="css" href="_io-base.css">
  <link rel="import" type="css" href="_io-editable.css">
  <template></template>
</dom-module>
<script type="text/javascript">
  (function() {

    var isValidNumberString = function(string) {
      if (typeof string !== 'string') return false;
      if (string === '') return true;
      if (string.slice(0, 1) === '0' && (string.length > 1 && string.slice(1, 2) !== '.')) {
        return false;
      }
      if (!isNaN(string)) {
        return true;
      } else {
        return false;
      }
    };
    var validMetaKeys = [65, 82, 88, 67, 86];
    var validKeys = [46, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 189, 190, 37, 38, 39, 40, 8, 9];

    Polymer({
      is: 'io-number',
      properties: {
        value: {
          value: null,
          type: Number
        },
        immediatevalue: {
          value: 0,
          type: Number
        },
        type: {
          value: 'number'
        }
      },
      behaviors: [
        Polymer.IoBaseBehavior,
        Polymer.IoEditableBehavior
      ],
      created: function() {
        this.addEventListener('immediatevalue-changed', function(event) {
          this.invalid = (typeof this.immediatevalue !== 'number' && this.immediatevalue !== null && this.immediatevalue !== undefined);
        }.bind(this));
      },
      _onBlur: function(event) {
        event.stopPropagation();
        this._deselectContent();
        if (!isValidNumberString(this.innerHTML)) {
          this.innerHTML = String(this.immediatevalue);
        }
        if (this.clickmasked) this._disabledChanged();
        this._getEditorValue();
        if (this.immediatevalue !== this.value) {
          this._setValue(this.immediatevalue);
        }
      },
      _validateKey: function(event) {
        if (event.metaKey && validMetaKeys.indexOf(event.which) !== -1) {
          return true;
        }
        if (validKeys.indexOf(event.which) === -1) {
          return false;
        }
        return true;
      },
      _getEditorValue: function(event) {
        if (isValidNumberString(this.innerHTML)) {
          if (this.innerHTML === '') {
            this.immediatevalue = null;
          } else {
            this.immediatevalue = Number(this.innerHTML);
          }
          this.invalid = false;
        } else {
          this.invalid = true;
          console.warn('io-number: not valid number value!');
        }
      },
      _immediatevalueChanged: function() {
        if (document.activeElement !== this) {
          if (this.immediatevalue === undefined || this.immediatevalue === null || this.immediatevalue === '' || this.immediatevalue === '') {
            this.innerHTML = '';
          } else {
            this.innerHTML = String(this.immediatevalue);
          }
        }
      }
    });
  })();
</script>

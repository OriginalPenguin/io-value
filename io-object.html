<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../observe-js/observe-js.html">
<!-- <link rel="import" href="../iron-list/iron-list.html"> -->
<link rel="import" href="io-boolean-icon.html">
<link rel="import" href="io-object-item.html">

<dom-module id="io-object">
  <style>
    .io-constructor {
      cursor: pointer;
      white-space: nowrap;
    }
    .io-constructor-name {
      font-style: italic;
    }
    .io-constructor-length {
    }
    .io-constructor-length::before {
      content: '[';
    }
    .io-constructor-length::after {
      content: ']';
    }
    #io-properties {
      /* TODO: test with fixed height and iron-list */
      /*overflow-x: hidden;*/
      /*overflow-y: auto;*/ 
      margin-left: 1em;
    }
  </style>
  <template>
    <span class="io-constructor">
      <io-boolean-icon id="expandicon" tabindex="-1" value="{{expanded}}" trueicon="expand-more" falseicon="chevron-right"></io-boolean-icon>
      <span on-tap="toggleExpanded">
        <span class="io-constructor-name">{{value.constructor.name}}</span>
        <span class="io-constructor-length">{{observedkeys.length}}</span>
      </span>
    </span>
    <template is="dom-if" if="{{expanded}}">
      <div id="io-properties"><!-- flex?="{{corelist}}" -->
        <template is="dom-repeat" items="{{observedkeys}}">
          <io-object-item
              object="{{value}}"
              value="{{item.value}}"
              key="{{item.key}}"
              disabled="{{disabled}}">
          </io-object-item>
        </template>
      </div>
    </template>
  </template>
</dom-module>

<script type="text/javascript">
(function() {
  var i, observedkeys, keys;
  Polymer({
    is: 'io-object',
    properties: {
      value: {
        // notify: true,
        observer: '_valueChanged'
      },
      disabled: {
        value: false,
        type: Boolean
      },
      expanded: {
        value: false,
        // notify: true,
        type: Boolean,
        observer: '_expandedChanged'
      },
      // corelist: {
      //   value: false,
      //   type: Boolean
      // },
      //
      observedkeys: {
        type: Array
      }
    },
    hostAttributes: {
      vertical: true,
      layout: true,
      oncontextmenu: 'return false;',
      role: 'tree'
    },
    listeners: {
      'io-object-add-item-after': '_onAddItemAfter'
    },
    toggleExpanded: function() {
      this.expanded = !this.expanded;
    },
    focus: function() {
      this.$.expandicon.focus();
    },
    _onAddItemAfter: function(event) {
      event.stopPropagation();
      observedkeys = [];
      for (i = 0; i < this.observedkeys.length; i++) {
        observedkeys.push(this.observedkeys[i]);
        if (this.observedkeys[i].key === event.detail.key) {
          observedkeys.push({
            key: null, value: null
          });
        }
      }
      // TODO: does not work on non-chrome
      this.observedkeys = observedkeys;
      requestAnimationFrame(function() {
        var item = this.$$('io-object-item[key="' + event.detail.key + '"]');
        item.nextElementSibling.keyeditor.focus();
      }.bind(this));
    },
    _expandedChanged: function() {
      if (this.expanded && this.observedkeys && this.observedkeys.length === 0) {
        this.observedkeys = [{key: null, value: null}];
      }
      if (this.expanded) {
        this.setAttribute('aria-expanded', '');
      } else {
        this.removeAttribute('aria-expanded');
      }
    },
    _valueChanged: function(value, oldValue) {
      //TODO: smarted observe
      this.observedkeys = [];
      if (!this.value || typeof this.value !== 'object') return;
      this.__updateKeys = this._updateKeys.bind(this);
      this.__updateKeys();

      if (this.__observer) this.__observer.close();
      this.__observer = new ObjectObserver(this.value);
      this.__observer.open(function() {
        this.__updateKeys();
      }.bind(this));
    },
    _updateKeys: function() {
      observedkeys = [];
      if (this.value instanceof Array) {
        for (i = 0; i < this.value.length; i++) {
          observedkeys.push({key: i, value: this.value[i]});
        }
      } else {
        keys = Object.keys(this.value);
        for (i in keys) {
          observedkeys.push({key: keys[i], value: this.value[keys[i]]});
        }
      }
      this.observedkeys = observedkeys;
    }
  });
}());
</script>

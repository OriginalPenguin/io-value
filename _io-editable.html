<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="_io-base.html">
<link rel="import" href="_io-validator.html">
<script>
  /* @polymerBehavior Polymer.IoEditable */
  Polymer.IoEditable = [Polymer.IoBase, Polymer.IoValidator, {
    properties: {
      /**
       * Element's value.
       * @type {*}
       */
      value: {
        value: '',
        notify: true,
        observer: '_valueChanged'
      },
      /**
       * Element's immediate value (updated on each keystroke).
       * @type {*}
       */
      immediatevalue: {
        value: '',
        notify: true,
        observer: '_immediatevalueChanged'
      },
      /**
       * Type of element's current value
       * Supported types are: null, undefined, NaN, function, string, number, array and object
       */
      type: {
        value: '',
        type: String,
        reflectToAttribute: true
      }
    },
    hostAttributes: {
      contenteditable: true,
      spellcheck: 'false'
    },
    listeners: {
      'focus': '_onFocus',
      'blur': '_onBlur',
      'keydown': '_onKeydown',
      'keyup': '_onKeyup'
    },
    _onFocus: function(event) {
      this._selectContent();
    },
    _onBlur: function(event) {
      event.stopPropagation();
      this._deselectContent();
      if (this.clickmasked) this._disabledChanged();
      this._getEditorValue();
      if (this.immediatevalue !== this.value) {
        this.setValue(this.immediatevalue);
      }
    },
    _onKeydown: function(event) {
      if (this.isNavigationKey(event) || this.isMetaKey(event)) {
        return;
      } else if (this.isEnterKey(event)) {
        event.preventDefault();
        this._getEditorValue();
        this.setValue(this.immediatevalue);
      } else if (this.disabled) {
        event.preventDefault();
      } else if (this.invalid) {
        event.preventDefault();
        var type = typeof this.value;
        if (this.value === null) type = 'null';
        if (this.value instanceof Array) type = 'array';
        console.warn(this.localName + ': cannot edit value of type', type);
      } else if (typeof this.value == 'number' && !this.isNumberKey(event) && !this.isEditKey(event)) {
        event.preventDefault();
      }
    },
    _onKeyup: function(event) {
      this._getEditorValue();
    },
    _getEditorValue: function(event) {
      this.innerHTML = this.textContent;
      if (!this.invalid) {
        if (this.textContent === '') {
          if (typeof this.immediatevalue === this.properties.type.value) {
            this.immediatevalue = null;
          }
        } else {
          this.immediatevalue = this.textContent;
        }
      }
    },
    _selectContent: function(selectAll) {
      this.focus();
      var range = document.createRange();
      range.selectNodeContents(this);
      if (!selectAll) {
        range.collapse(false);
      }
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    },
    _deselectContent: function() {
      var selection = window.getSelection();
      selection.removeAllRanges();
      this.scrollLeft = 0;
    },
    _valueChanged: function() {
      this.immediatevalue = this.value;
    },
    _immediatevalueChanged: function() {
      this.invalid = (typeof this.immediatevalue !== this.properties.type.value && this.immediatevalue !== null && this.immediatevalue !== NaN && this.immediatevalue !== undefined);
      if (this.immediatevalue === null) {
        this.type = 'null';
      } else if (this.immediatevalue === undefined) {
        this.type = 'undefined';
      } else if (this.immediatevalue === NaN) {
        this.type = 'NaN';
      } else if (typeof this.immediatevalue === 'function') {
        this.type = 'function';
      } else if (typeof this.immediatevalue === 'string') {
        this.type = 'string';
      } else if (typeof this.immediatevalue === 'number') {
        this.type = 'number';
      } else if (this.value instanceof Array) {
        this.type = 'array';
      } else if (typeof this.immediatevalue === 'object') {
        this.type = 'object';
      }
      if (document.activeElement !== this) {
        this._commitImmediatevalue();
      }
    },
    _commitImmediatevalue: function() {
      if (this.immediatevalue === null) {
        this.textContent = '';
      } else if (this.immediatevalue === undefined) {
        this.textContent = '';
      } else if (this.immediatevalue === NaN) {
        this.textContent = '';
      } else if (typeof this.immediatevalue === 'object') {
        this.textContent = '';
      } else if (typeof this.immediatevalue === 'function') {
        this.textContent = '';
      } else {
        this.textContent = String(this.immediatevalue);
      }
    },
    _disabledChanged: function() {
      if (this.disabled) {
        this.removeAttribute('tabindex');
        this.removeAttribute('contenteditable');
        this.setAttribute('aria-disabled', '');
      } else {
        this.setAttribute('tabindex', 0);
        this.setAttribute('contenteditable', '');
        this.removeAttribute('aria-disabled');
      }
    }
  }];
</script>
